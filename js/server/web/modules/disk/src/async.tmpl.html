<script id="async" type="text/html" nowith="yes">
    <!DOCTYPE html>
    <!--[if lt IE 7 ]> <html class="ie6"> <![endif]-->
    <!--[if IE 7 ]> <html class="ie7"> <![endif]-->
    <!--[if IE 8 ]> <html class="ie8"> <![endif]-->
    <!--[if IE 9 ]> <html class="ie9"> <![endif]-->
    <!--[if (gt IE 9)|!(IE)]>--> <html> <!--<![endif]-->
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta charset="utf-8"/>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <title>微云网页版</title>
        <meta name="Keywords" content="QQ, 腾讯,微云, 分享, 网盘, 网络硬盘, U盘, 云存储, 传输, 存储, 同步, 备份, 拍照, 上传, 下载, 中转, 文件, 照片, 相册, 离线, 传文件, wifi, cloud, 微云网页版, weiyun, weiyun web"/>
        <meta name="Description" content="微云是腾讯公司为用户精心打造的一项智能云服务, 您可以通过微云方便地在手机和电脑之间同步文件、推送照片和传输数据。"/>
        <%
            var g_info = window['g_weiyun_info'];
            var serverConfig = plug('config') || {};
            var is_test_env = serverConfig.isTest ? true : false;
        %>
        <script type="text/javascript">
            document.domain = 'weiyun.com';
            var IS_TEST_ENV = <%=is_test_env%>;
            var g_start_time = new Date(), IS_APPBOX = <%=g_info.is_appbox%>, IS_QZONE = <%=g_info.is_qzone%>, IS_PHP_OUTPUT = false, IS_DEBUG = <%=g_info.is_debug%>, g_err;
            var g_use_cgiv2 = true;
            IS_DEBUG || (window.onerror = function (msg, file, line) { g_err={ msg:msg||'',file:file||'',line:line||'' };return true;});
        </script>
        <%
            var configs_css = require('weiyun/conf/configs_css');
            var is_appbox = g_info.is_appbox;
            var serv_taken = new Date() - g_info.server_start_time;
            var body_class = is_appbox ? 'app-appbox' : 'web-app';
            var css_list = [];
            if(is_appbox) {
                css_list.push('base_css');
                css_list.push('p_appbox_css');
            } else {
                css_list.push('page_home_css');
            }

        %>
        <%=require('weiyun/util/inline').css(css_list, true)%>
        <script type="text/javascript">
            g_css_time = new Date();
            //防止用户使用通过浏览器访问appbox
            if(IS_APPBOX && (!window.external || !window.external.UploadFile) && !IS_DEBUG) {
                location.href = 'http://www.weiyun.com/disk/index.html';
            }
        </script>
        <% if(is_appbox) { %>
            <style type="text/css">
                #loading-text, #loading-icon {position:fixed;_position:absolute;margin:auto 0;/*left:50%;top:50%;*/z-index:100;}
                #loading-text {width:200px;height:36px;font: 36px/1.5 arial;color: #666;font-family: Tahoma, Helvetica, Arial, sans-serif;z-index:1000;display:block;text-align:center;line-height:36px;}
                #loading-icon {width:16px;height:16px;background: url(//img.weiyun.com/vipstyle/nr/box/web/images/loading3.gif) no-repeat 0 0;}
            </style>
        <% } %>
    </head>
    <body class="<%=body_class%>">
        <button id="_aria_start_trigger" style="position:absolute;top:-200px;" type="button" tabindex="0" onclick="window.open('http://support.qq.com/write.shtml?fid=811');">欢迎使用微云网盘，如果您读屏遇到问题，点击这里进行反馈。</button>
        <script type="text/javascript">document.getElementById('_aria_start_trigger').focus();</script>
        <script type="text/javascript" src="//ui.ptlogin2.qq.com/js/ptloginout.js"></script>
        <% if(g_info['is_debug']) {%>
        <script type="text/javascript" src="//img.weiyun.com/club/weiyun/js/publics/seajs/sea.js?max_age=31104000"></script>
        <% } else { %>
        <script type="text/javascript" src="//img.weiyun.com/c/=/club/weiyun/js/publics/seajs/sea.js,/club/weiyun/js/publics/seajs-plugins/seajs-combo.js?max_age=31104000"></script>
        <% } %>
        <%=require('weiyun/util/inline').js([is_appbox ? 'configs_appbox' : 'configs_web_v2'])%>
        <script type="text/javascript">
            /*
             * 初始化微云网盘
             */

            /**
             * 定义 appbox 外部接口，将生成一个空方法，被调用后会保留之前的参数，等待相应模块就绪后自行处理
             * @param {String} name
             * @returns {Function}
             */
            (function () {
                var win = window,
                        call_history_map = window.__call_history_map = {},
                        appbox_interface = function (name) {
                            return win[name] = function () {
                                var historys = call_history_map[name] || (call_history_map[name] = []);
                                historys.push(arguments);
                            };
                        };

                // 上传到微云
                appbox_interface('WYCLIENT_UploadFiles');

                // 检查是否可拖拽上传（disk模块中会实现该方法）
                win.support_plugin_drag_upload = function () {
                    return 0;
                };
            })();

            /**
             * 初始化
             */
            (function (win, seajs) {
                document.domain = 'weiyun.com';

                var g_serv_taken = win.g_serv_taken,
                        g_start_time = win.g_start_time || new Date(),
                        g_page_time = win.g_page_time;

                // 初始化微云
                var init = win.disk_init = function (opt) {

                    // 合并基础库
                    seajs.use(['$', 'lib']);
                    // 合并 main + disk + 延迟加载的样式
                    seajs.use(['lib', 'common', 'main', 'disk', 'page_home_delay_css'], function (lib, common, main_mod, disk_mod) {
                        var g_js_time = new Date(),
                            console = lib.get('./console'),
                            store = lib.get('./store'),
                            JSON = lib.get('./json'),
                            constants = common.get('./constants'),
                            wy_init = common.get('./init.init'),
	                        huatuo_speed = common.get('./huatuo_speed'),
                            query_user = common.get('./query_user'),
                            cgi_ret_report = common.get('./cgi_ret_report'),
                            global_event = common.get('./global.global_event'),
                            main = main_mod.get('./main'),
                            disk = disk_mod.get('./disk');

	                    // 初始化一些全局兼容性修正
                        wy_init();

                        // 延迟加载一些模块
                        main
                            // 默认模块
                                .set_default_module('disk')
                            // 模块hash参数名
                                .set_module_hash_key('m')
                            // 设置模块路径（供异步载入模块使用）
                                .set_async_modules_map({
                                    disk: './disk',
                                    recycle: './recycle',
                                    recent: './recent',
                                    album: './photo_group',
                                    photo: './photo_bridge',
                                    photo_time: './photo_time',
                                    share: './share',
                                    search: './search',
                                    doc: './doc',
                                    video: './video',
                                    audio: './audio',
                                    clipboard: './clipboard',
                                    note:'./note'
                                })
                            //虚拟映射模块
                                .set_virtual_modules_map({
                                    offline: {
                                        point: 'disk',
                                        after: function () {//激活后，待执行的任务
                                            global_event.trigger('disk_open_offline');
                                        }
                                    }
                                });


                        // 处理直出数据
                        var usr_rsp_head = win.g_login_user_rsp_head,
                                usr_rsp_body = win.g_login_user_rsp_body,
                                disk_files_rsp_body = win.g_disk_root_files_rsp_body;
                        if (usr_rsp_head && usr_rsp_body) {
                            var usr = query_user.set_init_data(usr_rsp_head, usr_rsp_body);
                            if (usr && disk_files_rsp_body) {
                                disk.set_init_data(usr, disk_files_rsp_body);
                            }
                        }
                        // 初始化 main 模块
                        main.render();

	                    // 测速配置
	                    var flag;
	                    if(window.location.protocol == 'https:') {
		                    flag = '21254-1-22';
	                    } else {
		                    flag = '21254-1-23';
	                    }
                        // 页面加载完成的时间
                        g_page_time = g_page_time || new Date();
                        setTimeout(function () {
                            if(opt && opt.output) {
                                cgi_ret_report.report("http://www.weiyun.com/app.php", "out", opt.output.ret, opt.output.spend_time);
                            }
	                        //测速点上报
	                        huatuo_speed.store_point(flag, 20, g_page_time - g_start_time);
	                        if(g_css_time) {
		                        huatuo_speed.store_point(flag, 21, g_css_time - g_start_time);
	                        }
	                        if(g_js_time) {
		                        huatuo_speed.store_point(flag, 22, g_js_time - g_start_time);
	                        }
	                        huatuo_speed.report(flag, true);
                        }, 0);


                        // 客户端接口（上传到微云等）
                        try {
                            var arr = store.get('WY_AIO_to_upload');
                            if (arr) {
                                arr = JSON.parse(arr);
                                WYCLIENT_UploadFiles(arr.length, arr.join('*'), 'AIO');
                            }
                            store.remove('WY_AIO_to_upload');
                        } catch (e) {
                            console.error(e.stack);
                        }

                    });
                };

            })(window, seajs);


            // TODO 移除该行和 preview_error.html 中对应的引用
            var WY_VERSION = 2;

        </script>



        <script type="text/javascript">
            disk_init({
                output: {
                    ret: <%=data && data.ret || 17002%>,
                    spend_time: 0
                }
            });
        </script>
        <script type="text/javascript">
            var pvClickSend;
            setTimeout(function () {
                seajs.use(window.location.protocol + '//img.weiyun.com/club/weiyun/js/publics/tcss/tcss.ping.js', function() {
                    pvClickSend = function (tag) {
                        if (typeof(pgvSendClick) == "function") {
                            pgvSendClick({
                                hottag: tag,
                                virtualDomain: 'www.weiyun.com'
                            });
                        }
                    };
                    if (typeof pgvMain == 'function') {
                        pgvMain("", {
                            tagParamName: 'WYTAG',
                            virtualURL: window.IS_APPBOX ? 'appbox/disk/index.html': 'disk/index.html',
                            virtualDomain: "www.weiyun.com"
                        });
                    }
                });
            }, 5000);
        </script>
    </body>
</html>
</script>