<!DOCTYPE HTML>
<html lang="zh-cn">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Language" content="zh-cn" />
<meta http-equiv="X-UA-Compatible" content = "IE=edge,chrome=1" />
<meta name="author" content="Tencent-ISUX" />
<meta name="Copyright" content="Tencent" />
<title>微云</title>
<script type="text/javascript" src="//imgcache.qq.com/c/=/club/weiyun/js/publics/jquery/jquery-1.8.3.min.js,/club/weiyun/js/publics/seajs/sea.js,/club/weiyun/js/publics/seajs-plugins/seajs-combo.js?max_age=31104000"></script>
<script type="text/javascript" src="//www.weiyun.com/disk/js/configs_web.js"></script>
</head>
	<body>
     <div id="_config" style="display:none;text-align: center;margin-top:30px;">
         <label for="ip">白名单：</label><input id="_ip" name="ip" style="width:200px;">
         <input type="submit" value="添加"  id="save"/>
         <span style="color:gray">一次只可添加一个QQ号，添加完后可重复添加</span>
     </div>
     <script type="text/javascript">
         document.domain = 'weiyun.com';
         seajs.use(['lib', 'common','qq_login'], function(lib, common, qq_login) {
             var query_user = common.get('./query_user'),
                 request = common.get('./request'),
                 qq_login = qq_login.get('./qq_login');

             var msgs = {
                 190011: '无效的QQ号码',
                 190051: ''
             }

             qq_login.on('qq_login_ok', function() {
                 verify_admin();
             });

             qq_login.show();

             function verify_admin() {
                 request.get({
                     url: '//web2.cgi.weiyun.com/share_white_list_add.fcg',
                     cmd: 'share_add_uin',
                     cavil: true,
                     re_try: 0,
                     body: {
                         uin_list: []
                     }
                 }).ok(function(msg, body) {
                     $('#_config').show();
                     reset_global_timer();
                 }).fail(function(msg, ret) {
                     if(ret == '228001') {
                         msg = '无操作权限';
                         query_user.destroy();
                         location.href = '../../../../../../../../../www.weiyun.com';
                         alert(msg);
                     }
                 });
             }

             var global_timer;
             function reset_global_timer() {
                clearTimeout(global_timer);
                 global_timer = setTimeout(function() {
                     query_user.destroy();
                     location.href = location.href;
                 }, 5 * 60 * 1000);
             }

             var save_req;
             function save_config(ip) {
                if(save_req) {
                    return;
                }
                reset_global_timer();
                save_req = request.get({
                    url: '//web2.cgi.weiyun.com/share_white_list_add.fcg',
                     cmd: 'share_add_uin',
                    cavil: true,
                    re_try: 0,
                    body: {
                        uin_list: [ip]
                    }
                }).ok(function(msg, body) {
                    alert('添加'+ip+'成功');
                    $('#_ip').val('').focus();
                }).fail(function(msg, ret) {
                    if(ret == '228001') {
                        msg = '无操作权限';
                        query_user.destroy();
                        location.href = '../../../../../../../../../www.weiyun.com';
                    } else if(ret == '190051') {
                        query_user.destroy();
                        location.href = location.href;
                    } else if(ret == '190011') {
                        msg = '无效的QQ号码'
                    }
                    alert(msg || '添加失败');
                    $('#_ip').val('').focus();
                }).done(function() {
                    save_req = null;
                });
             }

             $('#save').on('click', function(e) {
                 e.preventDefault();
                 var ip = $.trim($('#_ip').val());
                 if(/^\d+$/.test(ip)) {
                    save_config(ip);
                 } else {
                     alert('请输入正确的QQ号码，一次只能输入一个');
                     $('#_ip').val('').focus();
                 }
             });
         });
     </script>
    </body>
</html>